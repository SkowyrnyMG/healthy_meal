---
import AppLayout from "@/layouts/AppLayout.astro";
import CollectionDetailLayout from "@/components/collections/detail/CollectionDetailLayout";
import type { CollectionDetailDTO } from "@/types";

// Disable prerendering for this dynamic route
export const prerender = false;

// ============================================================================
// SERVER-SIDE DATA FETCHING
// ============================================================================

// Get collection ID from route params
const { id: collectionId } = Astro.params;

// Validate collection ID exists
if (!collectionId) {
  return Astro.redirect("/collections");
}

// Fetch initial collection data (page 1, limit 20)
let initialCollection: CollectionDetailDTO | null = null;
let initialFavorites = new Set<string>();
let errorMessage: string | null = null;

try {
  // Fetch collection from API endpoint
  const apiUrl = new URL(`/api/collections/${collectionId}`, Astro.url);
  apiUrl.searchParams.set("page", "1");
  apiUrl.searchParams.set("limit", "20");

  const response = await fetch(apiUrl, {
    method: "GET",
    headers: {
      // Forward cookies for authentication
      cookie: Astro.request.headers.get("cookie") || "",
    },
  });

  // Handle error responses
  if (!response.ok) {
    if (response.status === 404) {
      // Collection not found
      return Astro.redirect("/collections");
    }

    if (response.status === 403) {
      // Unauthorized access
      return Astro.redirect("/collections");
    }

    if (response.status === 401) {
      // Not authenticated (should be caught by AppLayout)
      return Astro.redirect("/login");
    }

    // Generic error - set error message
    const errorData = await response.json().catch(() => ({}));
    errorMessage = errorData.message || "Nie udało się pobrać kolekcji";
  } else {
    // Parse collection data
    initialCollection = await response.json();

    // Extract favorite recipe IDs
    // Fetch user's favorites using the same API pattern
    try {
      const favoritesResponse = await fetch(new URL("/api/favorites", Astro.url), {
        method: "GET",
        headers: {
          // Forward cookies for authentication
          cookie: Astro.request.headers.get("cookie") || "",
        },
      });

      if (favoritesResponse.ok) {
        const favoritesData = await favoritesResponse.json();
        // API returns { favorites: FavoriteDTO[], pagination: PaginationDTO }
        if (favoritesData.favorites && Array.isArray(favoritesData.favorites)) {
          initialFavorites = new Set(favoritesData.favorites.map((f: { recipeId: string }) => f.recipeId));
        }
      }
    } catch (error) {
      // eslint-disable-next-line no-console
      console.error("[collections/[id]] Failed to fetch favorites:", error);
      // Continue without favorites - they'll show as unfavorited
    }
  }
} catch (error) {
  // eslint-disable-next-line no-console
  console.error("[collections/[id]] Server fetch error:", error);
  errorMessage = "Wystąpił błąd podczas pobierania kolekcji";
}

// If we have an error and no collection data, redirect
if (errorMessage && !initialCollection) {
  return Astro.redirect("/collections");
}

// Page title
const pageTitle = initialCollection ? initialCollection.name : "Kolekcja";
---

<AppLayout title={pageTitle}>
  <!-- Collection Detail Section -->
  <section class="py-8">
    <div class="container mx-auto px-4">
      {
        initialCollection ? (
          <CollectionDetailLayout
            client:load
            initialCollection={initialCollection}
            initialFavorites={Array.from(initialFavorites)}
          />
        ) : (
          /* Error state */
          <div class="flex min-h-[400px] items-center justify-center">
            <div class="text-center">
              <h2 class="text-2xl font-bold text-gray-900">Nie można załadować kolekcji</h2>
              <p class="mt-2 text-gray-600">{errorMessage || "Wystąpił nieoczekiwany błąd"}</p>
              <a
                href="/collections"
                class="mt-4 inline-block rounded-md bg-green-600 px-4 py-2 text-white hover:bg-green-700"
              >
                Wróć do kolekcji
              </a>
            </div>
          </div>
        )
      }
    </div>
  </section>
</AppLayout>
